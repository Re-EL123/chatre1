<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatre LLM | Maerd</title>

<style>
/* ================== MAERD STYLING ================== */
:root {
  --primary-color: #fff;
  --primary-hover: #ccc;
  --light-bg: #000;
  --border-color: #222;
  --text-color: #fff;
  --text-light: #888;
  --user-msg-bg: rgba(39, 56, 82, 0.85);
  --assistant-msg-bg: rgba(20, 22, 44, 0.8);
  --accent: linear-gradient(270deg, red, orange, yellow, green, cyan, blue, violet);
}
body {
  font-family: 'Inter','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif;
  line-height:1.6;
  color:var(--text-color);
  background:var(--light-bg);
  max-width:800px;
  margin:0 auto;
  padding:1rem;
}
.spectrum-strip {
  height: 4px;
  background: var(--accent);
  background-size: 400% 400%;
  animation: slide 5s ease infinite;
}
@keyframes slide {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
header {
  text-align:center;
  margin-bottom:1rem;
  padding:1rem 0;
  border-bottom:1px solid var(--border-color);
  background:rgba(20,22,44,0.6);
  backdrop-filter:blur(3px);
}
h1 {
  font-size:1.6rem;
  color:var(--primary-color);
  letter-spacing:2px;
}
.chat-container {
  display:flex;
  flex-direction:column;
  height:calc(100vh - 200px);
  min-height:400px;
  border:1.5px solid var(--border-color);
  border-radius:16px;
  overflow:hidden;
  background:rgba(20,22,44,0.7);
  box-shadow:0 8px 40px #16161a;
  backdrop-filter:blur(8px);
}
.chat-messages {
  flex:1;
  overflow-y:auto;
  padding:1rem;
  background:linear-gradient(120deg,#000 60%,#111 100%);
}
.message {
  margin-bottom:1rem;
  padding:0.95rem;
  border-radius:12px;
  max-width:80%;
  font-size:1.05rem;
}
.user-message {
  background:var(--user-msg-bg);
  align-self:flex-end;
  margin-left:auto;
  color:#eaf2fb;
}
.assistant-message {
  background:var(--assistant-msg-bg);
  align-self:flex-start;
  color:#bbc8e7;
  animation:fadeInUp 0.6s ease;
}
@keyframes fadeInUp {
  from{opacity:0;transform:translateY(20px);}
  to{opacity:1;transform:translateY(0);}
}
.message-input {
  display:flex;
  padding:0.75rem;
  border-top:1px solid var(--border-color);
  background:rgba(15,23,42,0.9);
}
#user-input {
  flex:1;
  padding:0.75rem;
  border:1.5px solid var(--border-color);
  border-radius:8px;
  background:#000;
  color:var(--text-color);
  resize:none;
  min-height:44px;
  outline:none;
}
#user-input:focus {
  border-color:var(--primary-color);
}
#send-button {
  margin-left:0.5rem;
  padding:0 1rem;
  background:var(--accent);
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  font-size:1.02rem;
}
#send-button:disabled {
  background:#222;
  color:#666;
  cursor:not-allowed;
}
.typing-indicator {
  display:none;
  margin-bottom:1rem;
  font-style:italic;
  color:var(--primary-color);
}
.typing-indicator.visible { display:block; }
.image-message img {
  max-width:100%;
  border-radius:12px;
  margin-top:0.5rem;
}
#result {
  display:none;
  margin:1rem auto;
  max-width:100%;
  border:2px solid var(--primary-color);
  border-radius:12px;
}
footer {
  margin-top:1rem;
  text-align:center;
  font-size:0.9rem;
  color:var(--text-light);
}
</style>
  </head>
  <body>
    <div class="spectrum-strip"></div>
    <header>
      <h1>Chatre</h1>
      <p>Re-EL AI ChatBot (Maerd Portal)</p>
    </header>

    <div class="chat-container">
      <div id="chat-messages" class="chat-messages">
        <div class="message assistant-message">
          <p>Hello! I'm Chatre, your Maerd assistant. How can I help you today?</p>
        </div>
      </div>

      <div class="typing-indicator" id="typing-indicator"></div>

      <div class="message-input">
        <textarea id="user-input" placeholder="Type your message here..." rows="1" autofocus></textarea>
        <button id="send-button">Send</button>
      </div>
    </div>

    <!-- Hidden Image Preview -->
    <section id="image-preview">
      <h3 style="text-align:center;color:var(--primary-color);margin-top:1rem;">Generated Image Preview</h3>
      <img id="result" alt="Generated Image Preview">
    </section>

    <footer>
      <p>Re-EL Technologies &copy; 2025</p>
    </footer>

<script>
/* ================== HELPERS ================== */
function formatMarkdown(text){
  text=text.replace(/```([\s\S]*?)```/g,(m,code)=>`<pre><code>${code}</code></pre>`);
  text=text.replace(/`([^`]+)`/g,(m,code)=>`<code>${code}</code>`);
  text=text.replace(/\*\*([^\*]+)\*\*/g,'<strong>$1</strong>');
  text=text.replace(/\*([^\*]+)\*/g,'<em>$1</em>');
  return text;
}

const chatMessages=document.getElementById("chat-messages");
const userInput=document.getElementById("user-input");
const sendButton=document.getElementById("send-button");
const typingIndicator=document.getElementById("typing-indicator");
const resultImg=document.getElementById("result");
const imagePreview=document.getElementById("image-preview");

let chatHistory=[];
let isProcessing=false;

userInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendButton.click();}
});

sendButton.addEventListener("click",sendMessage);

function addMessage(role,content){
  const el=document.createElement("div");
  el.className=`message ${role}-message`;
  el.innerHTML=`<p>${formatMarkdown(content)}</p>`;
  chatMessages.appendChild(el);
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

/* ================== SMART SEND ================== */
async function sendMessage(){
  const message=userInput.value.trim();
  if(!message||isProcessing)return;
  // detect if it's an image request
  const lower=message.toLowerCase();
  if(lower.startsWith("draw")||lower.startsWith("create image")||lower.startsWith("generate image")||lower.startsWith("show me")||lower.startsWith("create an image")||lower.startsWith("generate an image")){
    return generateImage(message);
  }
  // else: normal chat
  isProcessing=true;
  userInput.value="";
  addMessage("user",message);
  typingIndicator.classList.add("visible");
  try{
    const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[...chatHistory,{role:"user",content:message}]})});
    const data=await res.json();
    addMessage("assistant",data.response||"...");
    chatHistory.push({role:"assistant",content:data.response});
  }catch(e){
    addMessage("assistant","⚠️ Error getting response.");
  }finally{
    typingIndicator.classList.remove("visible");
    isProcessing=false;
  }
}


/**
 * ================= IMAGE GENERATION =================
 */
async function generateImage(prompt) {
  isProcessing = true;
  userInput.disabled = true;
  sendButton.disabled = true;

  addMessageToChat("user", "[Image Request] " + prompt);

  userInput.value = "";
  userInput.style.height = "auto";

  typingIndicator.classList.add("visible");
  startThinkingAnimation();

  try {
    // === Call your Cloudflare Worker directly ===
    const response = await fetch("https://chatre-image-build.akanishibiri4422.workers.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt }),
    });

    if (!response.ok) throw new Error("Image API failed");

    // Get raw image blob
    const blob = await response.blob();
    const imageUrl = URL.createObjectURL(blob);

    addMessageToChat(
      "assistant",
      `Here is your generated image:<br><img src="${imageUrl}" alt="Generated Image" class="rounded-lg mt-2 max-w-xs shadow-md fade-in">`
    );
  } catch (err) {
    console.error("⚠️ Image generation failed:", err);
    addMessageToChat("assistant", "⚠️ Image generation failed.");
  } finally {
    stopThinkingAnimation();
    typingIndicator.classList.remove("visible");
    isProcessing = false;
    userInput.disabled = false;
    sendButton.disabled = false;
    userInput.focus();
  }
}
</script>
  </body>
</html>
